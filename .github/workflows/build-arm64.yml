name: ğŸš€ ARM64 Image Builder (Public Repo)

on:
  repository_dispatch:
    types: [build-arm64-image]
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        default: 'realstat-io/realstate-api'
      git_ref:
        description: 'Git reference (commit SHA, branch, or tag)'
        required: true
        default: 'main'
      image_tag:
        description: 'Image tag/version'
        required: true
        default: 'latest'
      dockerfile_path:
        description: 'Path to Dockerfile'
        required: false
        default: 'Dockerfile.api-server'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: realstat-io/realstate-api

jobs:
  build-arm64:
    name: ğŸ—ï¸ Build ARM64 Images (Fast!)
    runs-on: ubuntu-24.04-arm  
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write

    steps:
    - name: ğŸš€ ARM64 Build Started
      run: |
        echo "========================================="
        echo "ğŸš€ ARM64 Image Build on Public Repo"
        echo "========================================="
        echo "ğŸ“… Timestamp: $(date)"
        echo "ğŸ–¥ï¸ Runner: ubuntu-24.04-arm (FREE ARM64!)"
        echo "ğŸ“¦ Source: ${{ github.event.client_payload.source_repo || inputs.source_repo }}"
        echo "ğŸ¯ Git Ref: ${{ github.event.client_payload.git_ref || inputs.git_ref }}"
        echo "ğŸ·ï¸ Image Tag: ${{ github.event.client_payload.image_tag || inputs.image_tag }}"
        echo "ğŸ“ Dockerfile: ${{ github.event.client_payload.dockerfile_path || inputs.dockerfile_path }}"
        echo "âš¡ Expected Time: ~2-3 minutes (vs 45 min on emulation!)"
        echo "========================================="

    - name: ğŸ› ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/arm64

    - name: ğŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¥ Clone Source Repository
      run: |
        echo "ğŸ“¥ Cloning source repository..."
        SOURCE_REPO="${{ github.event.client_payload.source_repo || inputs.source_repo }}"
        GIT_REF="${{ github.event.client_payload.git_ref || inputs.git_ref }}"
        
        # Clone with specific ref
        git clone https://github.com/${SOURCE_REPO}.git source-code
        cd source-code
        git checkout ${GIT_REF}
        
        echo "âœ… Cloned ${SOURCE_REPO} at ${GIT_REF}"
        echo "ğŸ“‹ Commit info:"
        git log -1 --pretty=format:"  - Hash: %H%n  - Author: %an%n  - Date: %ad%n  - Message: %s" --date=short

    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=${{ github.event.client_payload.image_tag || inputs.image_tag }}
          type=raw,value=arm64-${{ github.event.client_payload.image_tag || inputs.image_tag }}
          type=sha,prefix=arm64-{{branch}}-

    - name: ğŸš€ Build ARM64 Image (FAST!)
      uses: docker/build-push-action@v6
      with:
        context: ./source-code
        file: ./source-code/${{ github.event.client_payload.dockerfile_path || inputs.dockerfile_path }}
        push: true
        platforms: linux/arm64
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1
          GOPROXY=https://proxy.golang.org,direct
          GOSUMDB=sum.golang.org

    - name: ğŸ‰ ARM64 Build Complete
      run: |
        echo "========================================="
        echo "ğŸ‰ ARM64 Build Complete in Public Repo!"
        echo "========================================="
        echo "ğŸ“¦ Images Built:"
        echo "${{ steps.meta.outputs.tags }}" | sed 's/^/  - /'
        echo ""
        echo "ğŸ—ï¸ Architecture: linux/arm64 (Native, no emulation!)"
        echo "âš¡ Build Time: Much faster than 45min emulated builds"
        echo "ğŸ’° Cost: FREE (public repository ARM runners)"
        echo ""
        echo "ğŸš€ Ready for deployment:"
        echo "  kubectl set image deployment/your-app container=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.client_payload.image_tag || inputs.image_tag }}"
        echo "========================================"

    - name: ğŸ“ Build Summary
      run: |
        cat << 'EOF' >> $GITHUB_STEP_SUMMARY
        ## ğŸ‰ ARM64 Build Summary
        
        | Property | Value |
        |----------|-------|
        | ğŸ–¥ï¸ Runner | `ubuntu-24.04-arm` (FREE!) |
        | ğŸ“¦ Source | `${{ github.event.client_payload.source_repo || inputs.source_repo }}` |
        | ğŸ¯ Git Ref | `${{ github.event.client_payload.git_ref || inputs.git_ref }}` |
        | ğŸ·ï¸ Image Tag | `${{ github.event.client_payload.image_tag || inputs.image_tag }}` |
        | ğŸ—ï¸ Architecture | `linux/arm64` |
        | âš¡ Build Method | Native (no emulation) |
        
        ### ğŸ“¦ Built Images:
        ```
        ${{ steps.meta.outputs.tags }}
        ```
        
        ### ğŸš€ Deployment:
        ```bash
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.client_payload.image_tag || inputs.image_tag }}
        ```
        EOF 